# Atelier Dataflow Gen2 - Calcul d'Empreinte Carbone et Reporting ESG

## üìå Introduction

### Contexte

Vous √™tes data analyst chez **GreenCorp Energy**, un producteur d'√©nergie multi-sources qui doit respecter les r√©glementations ESG (Environmental, Social, Governance) europ√©ennes.

**Objectif de l'atelier** : Cr√©er un pipeline automatis√© pour calculer l'empreinte carbone du mix √©nerg√©tique et g√©n√©rer des rapports ESG r√©glementaires.

---

## üîç √âtat des lieux

### Sources de donn√©es actuelles

| Fichier                              | Lignes | Probl√®mes                                                              |
| ------------------------------------ | ------ | ---------------------------------------------------------------------- |
| **production_sources_energie.csv**   | ~2,300 | ‚ùå Doublons (5%)<br>‚ùå Codes erreur -999<br>‚ùå Valeurs manquantes         |
| **consommation_secteurs.csv**        | ~1,460 | ‚ùå Format date incoh√©rent (DD/MM/YYYY)<br>‚ùå Pas de lien avec production |
| **facteurs_emission_reference.csv**  | 6      | ‚úÖ Donn√©es propres (table de r√©f√©rence)                                 |
| **meteo_quotidienne.csv**            | 365    | ‚úÖ Donn√©es propres                                                      |
| **objectifs_esg_reglementaires.csv** | 6      | ‚úÖ Donn√©es propres (2025-2030)                                          |
| **prix_certificats_co2.csv**         | 365    | ‚úÖ Donn√©es propres (EU ETS)                                             |

### Exemple de donn√©es probl√©matiques

**Production** :

```csv
date,source_energie,production_kwh,capacite_installee_kwh,cout_production_eur
2025-01-01,Solaire,15000.5,50000,1200.04
2025-01-01,Charbon,-999,150000,0  ‚Üê Code erreur
2025-01-01,Solaire,15000.5,50000,1200.04  ‚Üê DOUBLON
```

**Consommation** :

```csv
date_releve,secteur,consommation_kwh,nombre_sites
01/01/2025,Industrie,180000.5,250  ‚Üê Format DD/MM/YYYY
2025-01-02,Residentiel,120000.3,450  ‚Üê Format YYYY-MM-DD (incoh√©rent)
```

---

## ‚ö†Ô∏è Probl√©matique

### 3 d√©fis majeurs

**1. Calcul d'empreinte carbone impossible**

- Production et facteurs d'√©mission dans des fichiers s√©par√©s
- Pas de lien automatique source ‚Üí √©missions CO2
- **Impact** : Impossible de calculer les √©missions totales en temps r√©el

**2. Donn√©es sales emp√™chent le reporting**

- Doublons ‚Üí Surestimation des √©missions
- Codes erreur -999 ‚Üí Calculs fauss√©s
- Dates incoh√©rentes ‚Üí Impossible de croiser consommation/production

**3. Pas de pilotage des objectifs ESG**

- Pas de vue consolid√©e mix √©nerg√©tique vs objectifs 2030
- Calculs manuels dans Excel ‚Üí Erreurs + 2 jours de retard
- **Risque r√©glementaire** : Amendes si non-conformit√© EU Green Deal

---

## üí° Comment Dataflow Gen2 r√©sout ces probl√®mes

### Solution propos√©e

| Besoin                   | Solution Dataflow Gen2                            |
| ------------------------ | ------------------------------------------------- |
| **Calcul √©missions CO2** | Jointure production √ó facteurs_emission           |
| **Nettoyer donn√©es**     | Filtrage codes erreur + suppression doublons      |
| **Unifier dates**        | Transformation DD/MM/YYYY ‚Üí YYYY-MM-DD            |
| **Enrichir contexte**    | Jointure m√©t√©o + prix CO2 + objectifs ESG         |
| **Piloter objectifs**    | Colonnes calcul√©es (√©cart vs cible, co√ªt carbone) |

### Architecture cible

```
6 sources CSV ‚Üí Dataflow Gen2 ‚Üí Lakehouse ‚Üí Power BI Dashboard ESG
                     ‚Üì
         [Nettoyage + Calculs + Jointures]
                     ‚Üì
         Pipeline (refresh quotidien)
```

---

## üõ†Ô∏è Mise en ≈ìuvre pas √† pas

### Pr√©requis

- ‚úÖ Workspace Fabric
- ‚úÖ Lakehouse `LH_ESG_Carbon` cr√©√©
- ‚úÖ Fichiers CSV upload√©s dans `/Files/data_esg/`

---

### √âTAPE 1 : Cr√©er le Dataflow Gen2

**1.1 Initialisation**

1. Workspace ‚Üí **+ New** ‚Üí **Dataflow Gen2**
2. Nom : `DF_Calcul_Empreinte_Carbone_ESG`

**1.2 Ingestion des 6 sources**

1. **Get data** ‚Üí **OneLake data hub**
2. Naviguer : `Lakehouse ‚Üí Files ‚Üí data_esg`
3. S√©lectionner les 6 fichiers CSV
4. **Create** ‚Üí Power Query Editor

---

### √âTAPE 2 : Nettoyage des donn√©es

#### 2.1 Requ√™te `production_sources_energie`

**Actions** :

1. **Home** ‚Üí **Remove Duplicates** (toutes colonnes)
2. **Home** ‚Üí **Filter Rows** ‚Üí production_kwh ‚â† -999
3. **Home** ‚Üí **Remove Rows** ‚Üí **Remove Errors** (production_kwh)
4. **Transform** ‚Üí **Data Type** : date ‚Üí Date

**R√©sultat** : ~2,300 ‚Üí ~2,070 lignes (-10% de donn√©es invalides)

---

#### 2.2 Requ√™te `consommation_secteurs`

**Actions** :

1. **Transform** ‚Üí **Data Type** : date_releve ‚Üí Date
   - Power Query g√®re automatiquement DD/MM/YYYY et YYYY-MM-DD
2. **Transform** ‚Üí **Rename** : date_releve ‚Üí date

**R√©sultat** : Dates unifi√©es

---

#### 2.3 Requ√™tes de r√©f√©rence (pas de nettoyage)

- `facteurs_emission_reference`
- `meteo_quotidienne`
- `objectifs_esg_reglementaires`
- `prix_certificats_co2`

‚Üí Donn√©es propres, juste v√©rifier les types

---

### √âTAPE 3 : Calcul des √©missions CO2

#### 3.1 Enrichir production avec facteurs d'√©mission

1. S√©lectionner `production_sources_energie`
2. **Home** ‚Üí **Merge Queries** ‚Üí **Merge Queries as New**
3. Configuration :
   - Table gauche : production_sources_energie
   - Table droite : facteurs_emission_reference
   - Colonnes : source_energie = source_energie
   - Join : Left Outer
4. Nom : `production_avec_emissions`
5. Cliquer ‚áÑ ‚Üí S√©lectionner :
   - facteur_emission_kgco2_kwh
   - categorie
   - objectif_2030_pct

#### 3.2 Calculer les √©missions CO2

**Add Column** ‚Üí **Custom Column** :

```
Nom : emissions_co2_kg
Formule : [production_kwh] * [facteur_emission_kgco2_kwh]
```

**Add Column** ‚Üí **Custom Column** :

```
Nom : emissions_co2_tonnes
Formule : [emissions_co2_kg] / 1000
```

---

### √âTAPE 4 : Enrichissement contextuel

#### 4.1 Ajouter les donn√©es m√©t√©o

1. S√©lectionner `production_avec_emissions`
2. **Merge Queries as New** :
   - Droite : meteo_quotidienne
   - Colonnes : date = date
   - Join : Left Outer
3. Nom : `production_enrichie_meteo`
4. Expand : temperature_moy_c, ensoleillement_heures, vitesse_vent_mps

#### 4.2 Ajouter les prix CO2

1. **Merge Queries** (sur production_enrichie_meteo) :
   - Droite : prix_certificats_co2
   - Colonnes : date = date
   - Join : Left Outer
2. Expand : prix_tonne_co2_eur

#### 4.3 Calculer le co√ªt carbone

**Add Column** ‚Üí **Custom Column** :

```
Nom : cout_carbone_eur
Formule : [emissions_co2_tonnes] * [prix_tonne_co2_eur]
```

---

### √âTAPE 5 : Agr√©gation et KPIs

#### 5.1 Cr√©er une vue agr√©g√©e quotidienne

1. Dupliquer `production_enrichie_meteo` ‚Üí Nom : `emissions_quotidiennes`
2. **Transform** ‚Üí **Group By** :
   - Grouper par : date, categorie
   - Agr√©gations :
     - production_totale_kwh = Sum(production_kwh)
     - emissions_totales_tonnes = Sum(emissions_co2_tonnes)
     - cout_carbone_total_eur = Sum(cout_carbone_eur)

#### 5.2 Calculer la part renouvelable

**Add Column** ‚Üí **Custom Column** :

```
Nom : part_renouvelable_pct
Formule : 
let
    prod_renouvelable = if [categorie] = "Renouvelable" then [production_totale_kwh] else 0,
    prod_totale = List.Sum(#"Grouped Rows"[production_totale_kwh])
in
    (prod_renouvelable / prod_totale) * 100
```

**Simplification si trop complexe** : Cr√©er 2 requ√™tes s√©par√©es (Renouvelable/Fossile) et calculer dans Power BI

---

### √âTAPE 6 : Jointure avec objectifs ESG

#### 6.1 Ajouter la colonne ann√©e

Sur `emissions_quotidiennes` :

**Add Column** ‚Üí **Custom Column** :

```
Nom : annee
Formule : Date.Year([date])
```

#### 6.2 Jointure avec objectifs

1. **Merge Queries** :
   - Droite : objectifs_esg_reglementaires
   - Colonnes : annee = annee
   - Join : Left Outer
2. Expand :
   - reduction_emissions_pct
   - part_renouvelable_cible_pct
   - emissions_max_tonnes_co2

#### 6.3 Calculer les √©carts vs objectifs

**Add Column** ‚Üí **Custom Column** :

```
Nom : ecart_objectif_emissions_pct
Formule : ([emissions_totales_tonnes] / [emissions_max_tonnes_co2] - 1) * 100
```

**Add Column** ‚Üí **Custom Column** :

```
Nom : conforme_objectif
Formule : if [ecart_objectif_emissions_pct] <= 0 then "‚úÖ Conforme" else "‚ùå Non conforme"
```

---

### √âTAPE 7 : Traiter la consommation

#### 7.1 Nettoyer consommation_secteurs

D√©j√† fait (dates unifi√©es)

#### 7.2 Agr√©ger par date

1. Dupliquer ‚Üí Nom : `consommation_quotidienne`
2. **Group By** :
   - Grouper par : date
   - Agr√©gations :
     - consommation_totale_kwh = Sum(consommation_kwh)
     - nombre_sites_total = Sum(nombre_sites)

#### 7.3 Jointure production/consommation (optionnel)

Pour calculer le taux de couverture :

1. **Merge** production_enrichie + consommation_quotidienne (sur date)
2. Calculer : taux_couverture = production / consommation

---

### √âTAPE 8 : Configuration des destinations

#### 8.1 Table principale : emissions_carbone_detaillees

1. S√©lectionner `production_enrichie_meteo` (avec tous les enrichissements)
2. **Add data destination** ‚Üí **Lakehouse**
3. Configuration :
   - Table : `emissions_carbone_detaillees`
   - Update method : **Append**

#### 8.2 Table agr√©g√©e : emissions_quotidiennes_kpi

1. S√©lectionner `emissions_quotidiennes`
2. **Add data destination** ‚Üí **Lakehouse**
3. Configuration :
   - Table : `emissions_quotidiennes_kpi`
   - Update method : **Replace**

#### 8.3 Table consommation

1. S√©lectionner `consommation_quotidienne`

2. **Add data destination** ‚Üí **Lakehouse**

3. Configuration :
   
   - Table : `consommation_par_secteur`
   - Update method : **Append**

4. **Publish**

---

### √âTAPE 9 : Test et validation

**9.1 Premier refresh**

1. Workspace ‚Üí Dataflow ‚Üí **Refresh now**
2. Dur√©e attendue : 3-4 minutes

**9.2 Validation dans Lakehouse**

```sql
-- 1. V√©rifier les √©missions totales
SELECT 
    SUM(emissions_co2_tonnes) as emissions_totales_tonnes,
    AVG(prix_tonne_co2_eur) as prix_moyen_co2
FROM emissions_carbone_detaillees;

-- R√©sultat attendu : ~400,000 tonnes CO2 pour 2025

-- 2. V√©rifier la part renouvelable
SELECT 
    categorie,
    SUM(production_kwh) as production_totale,
    ROUND(SUM(production_kwh) * 100.0 / SUM(SUM(production_kwh)) OVER(), 2) as part_pct
FROM emissions_carbone_detaillees
GROUP BY categorie;

-- R√©sultat attendu :
-- Renouvelable : ~45%
-- Fossile      : ~55%

-- 3. V√©rifier conformit√© objectifs
SELECT 
    date,
    emissions_totales_tonnes,
    emissions_max_tonnes_co2,
    conforme_objectif
FROM emissions_quotidiennes_kpi
WHERE conforme_objectif = '‚ùå Non conforme'
LIMIT 10;
```

---

### √âTAPE 10 : Pipeline d'orchestration

**10.1 Cr√©er le Pipeline**

1. Workspace ‚Üí **+ New** ‚Üí **Data pipeline**
2. Nom : `Pipeline_Daily_ESG_Carbon_Reporting`

**10.2 Activit√©s**

1. **Dataflow** : `DF_Calcul_Empreinte_Carbone_ESG`
2. **Send email** (On Success) : "‚úÖ Rapport ESG mis √† jour"
3. **Send email** (On Failure) : "‚ùå √âchec calcul ESG"

**10.3 Planification**

- Repeat : Daily
- Time : 07:00 (apr√®s arriv√©e des donn√©es)

**10.4 Gestion d'erreurs**

- Retry : 3
- Retry interval : 60 seconds

---

## üéØ Conclusion et interpr√©tation

### Transformation effectu√©e

```
AVANT                           APR√àS
6 fichiers isol√©s          ‚Üí    3 tables unifi√©es
Pas de calcul CO2          ‚Üí    Emissions calcul√©es en temps r√©el
Donn√©es sales              ‚Üí    100% propres
Format Excel manuel        ‚Üí    Pipeline automatis√©
Retard de 2 jours          ‚Üí    Dashboard J+1
```

### KPIs ESG cr√©√©s

**1. Empreinte carbone**

- Emissions totales 2025 : ~400,000 tonnes CO2
- Co√ªt carbone : ~400,000 t √ó 85 ‚Ç¨/t = **34 M‚Ç¨**
- Par source :
  - Charbon : 35% des √©missions (mais 25% de production)
  - Gaz : 45% des √©missions (33% de production)
  - Renouvelables : 20% des √©missions (42% de production)

**2. Mix √©nerg√©tique**

- Part renouvelable : 45% (objectif 2025 : 40%) ‚úÖ
- Part fossile : 55% (√† r√©duire √† 10% d'ici 2030)

**3. Conformit√© r√©glementaire**

- Objectif √©missions 2025 : 500,000 t CO2 max
- R√©alis√© : 400,000 t CO2
- √âcart : -20% ‚úÖ **Conforme EU Green Deal**

### Valeur m√©tier

**Gains quantifiables** :

- ‚è±Ô∏è **Temps √©conomis√©** : 2 jours/mois √ó 12 = **24 jours/an** de reporting manuel √©limin√©
- üí∞ **Optimisation mix** : Identifier que le charbon √©met 2√ó plus que le gaz pour production √©quivalente ‚Üí Strat√©gie de sortie du charbon en priorit√©
- üìä **Transparence ESG** : Reporting automatique pour investisseurs et r√©gulateurs
- üéØ **Pilotage objectifs** : Suivi en temps r√©el de l'√©cart vs cibles 2030

**D√©cisions strat√©giques permises** :

1. **Prioriser sortie du charbon** (35% √©missions, seulement 25% production)
2. **Augmenter solaire/√©olien** (production d√©j√† √† 30%, peut passer √† 50%)
3. **Acheter certificats CO2** si d√©passement pr√©vu (alerte anticip√©e)
4. **N√©gocier prix √©nergie verte** avec visibilit√© co√ªt carbone √©vit√©
