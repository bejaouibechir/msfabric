# Atelier 3 : Gestion de crise Ã©nergÃ©tique avec orchestration multi-pipelines

## Contexte : RÃ©ponse coordonnÃ©e Ã  une panne Ã©nergÃ©tique majeure

Une **rÃ©gion mÃ©tropolitaine** subit une **panne Ã©nergÃ©tique majeure** causÃ©e par une tempÃªte hivernale exceptionnelle. Les infrastructures fossiles (gaz, charbon) sont gravement endommagÃ©es. Le centre de crise doit rapidement basculer vers les Ã©nergies alternatives (solaire, Ã©olien, hydrogÃ¨ne) et coordonner les acteurs pour rÃ©tablir l'alimentation Ã©lectrique.

### 1. Ã‰tat des lieux

- **25 dÃ©faillances** dÃ©tectÃ©es sur les infrastructures critiques
- **CapacitÃ© perdue** : ~2500 MW (60% de la capacitÃ© nominale)
- **20 sites de batteries** de secours disponibles (~2500 MWh)
- **40 acteurs** mobilisables (gouvernement, entreprises, services)
- **10 sites de conversion** gaz â†’ hydrogÃ¨ne opÃ©rationnels
- **75 sources alternatives** (solaire, Ã©olien, biomasse, hydro, gÃ©othermie)
- **20 actions post-crise** Ã  planifier

### 2. ProblÃ©matique

**Comment orchestrer automatiquement la rÃ©ponse Ã  une crise Ã©nergÃ©tique majeure en analysant les dÃ©faillances, priorisant les interventions selon la sÃ©vÃ©ritÃ©, mobilisant les ressources de backup, et coordonnant les acteurs pour une restauration rapide du service ?**

Contraintes :

- âœ… Diagnostic rapide des dÃ©faillances critiques
- âœ… Classification automatique du niveau de crise (1, 2 ou 3)
- âœ… Priorisation intelligente des interventions
- âœ… Identification des batteries mobilisables (charge > 50%)
- âœ… Orchestration sÃ©quentielle des pipelines avec traÃ§abilitÃ©
- âœ… Temps de rÃ©ponse < 2 minutes

### 3. Solution : SystÃ¨me d'orchestration intelligent

**3 pipelines complÃ©mentaires** :

1. **PL_Chargement_Crise** : Ingestion rapide des 6 sources de donnÃ©es
2. **PL_Analyse_Crise** : Analyse, classification et priorisation avec Switch
3. **PL_Orchestration_Crise** : Coordination et traÃ§abilitÃ© de bout en bout

---

## Fichiers nÃ©cessaires

TÃ©lÃ©chargez les **6 fichiers CSV** fournis :

- `diagnostic_defaillances.csv` (25 dÃ©faillances)
- `stockage_batteries.csv` (20 sites de batteries)
- `coordination_acteurs.csv` (40 acteurs mobilisables)
- `conversion_gazhydrogene.csv` (10 sites H2)
- `sources_alternatives.csv` (75 sources renouvelables)
- `plan_postcrise.csv` (20 actions d'amÃ©lioration)

---

## Ã‰tapes

### 1. CrÃ©er les lakehouses

#### Lakehouse 1 : DonnÃ©es de crise

1. Dans le workspace **WS_Energie_Renouvelable**, cliquez **+ New item**
2. SÃ©lectionnez **Lakehouse**
3. **Name** : `LH_Energie_Crisis`
4. Cliquez **Create**

â³ Attendez la crÃ©ation (15-30 secondes)

#### Lakehouse 2 : DonnÃ©es de dÃ©cision

5. RÃ©pÃ©tez l'opÃ©ration
6. **Name** : `LH_Energie_Decision`
7. Cliquez **Create**

---

### 2. Uploader les fichiers CSV

1. Ouvrez **LH_Energie_Crisis**
2. Section **Files** â†’ **New subfolder** : `crise`
3. Cliquez sur le dossier **crise**
4. **Upload files** â†’ SÃ©lectionnez les 6 CSV
5. Cliquez **Upload**

âœ… VÃ©rifiez : `Files/crise/` contient 6 fichiers

---

### 3. CrÃ©er les 3 pipelines

#### Pipeline 1 : Chargement

1. Dans le workspace, cliquez **+ New item** â†’ **Data pipeline**
2. **Name** : `PL_Chargement_Crise`
3. Cliquez **Create**

#### Pipeline 2 : Analyse

4. RÃ©pÃ©tez : **Name** = `PL_Analyse_Crise`

#### Pipeline 3 : Orchestration

5. RÃ©pÃ©tez : **Name** = `PL_Orchestration_Crise`

---

### 4. Configurer Pipeline 1 : Chargement

**Objectif** : Charger les 6 CSV en parallÃ¨le dans LH_Energie_Crisis

#### Copy 1 : Diagnostic

1. **Activities** â†’ **Copy data** â†’ glissez sur le canvas
2. Onglet **General** : **Name** = `ChargerDiagnostic`

**Source** :

- **Connection** : `LH_Energie_Crisis`
- **Root folder** : **Files**
- **File path** :
  - Folder : `crise`
  - File : `diagnostic_defaillances.csv`
- **File format** : **DelimitedText**
- **First row as header** : âœ…

**Destination** :

- **Connection** : `LH_Energie_Crisis`
- **Root folder** : **Tables**
- **Table** : `diagnostic` (cochez **Enter manually**)
- **Table action** : **Overwrite**

#### Copy 2-6 : Autres sources

3. Dupliquez **ChargerDiagnostic** 5 fois (Ctrl+C, Ctrl+V)
4. Renommez et configurez :

| Name                | File source                   | Table destination |
| ------------------- | ----------------------------- | ----------------- |
| `ChargerBatteries`  | `stockage_batteries.csv`      | `batteries`       |
| `ChargerActeurs`    | `coordination_acteurs.csv`    | `acteurs`         |
| `ChargerConversion` | `conversion_gazhydrogene.csv` | `conversion`      |
| `ChargerSources`    | `sources_alternatives.csv`    | `sources`         |
| `ChargerPostCrise`  | `plan_postcrise.csv`          | `postcrise`       |

âš ï¸ **Important** : Ne reliez PAS les activitÃ©s (exÃ©cution en parallÃ¨le)

5. Cliquez **Save**

---

### 5. Tester Pipeline 1

1. Cliquez **Run**
2. Attendez 30-60 secondes
3. VÃ©rifiez dans **LH_Energie_Crisis** â†’ **Tables** :
   - âœ… `diagnostic` (25 lignes)
   - âœ… `batteries` (20 lignes)
   - âœ… `acteurs` (40 lignes)
   - âœ… `conversion` (10 lignes)
   - âœ… `sources` (75 lignes)
   - âœ… `postcrise` (20 lignes)

---

### 6. Configurer Pipeline 2 : Analyse

**Objectif** : Classifier la crise, prioriser les interventions, filtrer les ressources

#### CrÃ©er les variables

Onglet **Variables** (en bas) :

**Variable 1** :

- **Name** : `DefaillancesCritiques`
- **Type** : `Integer`
- **Default value** : `0`

**Variable 2** :

- **Name** : `NiveauCrise`
- **Type** : `Integer`
- **Default value** : `1`

**Variable 3** :

- **Name** : `CapaciteBackupDisponible`
- **Type** : `Integer`
- **Default value** : `0`

#### ActivitÃ© 1 : Compter les dÃ©faillances critiques

1. **Activities** â†’ **Lookup** â†’ glissez

2. Onglet **General** : **Name** = `CompterDefaillancesCritiques`

3. Onglet **Settings** :
   
   - **Connection** : `LH_Energie_Crisis`
   - **Root folder** : **Tables**
   - **Use query** : **T-SQL Query**
   - **Query** :
   
   ```sql
   SELECT COUNT(*) as NbCritiques FROM diagnostic WHERE Severite = 'Critique'
   ```
   
   - **First row only** : âœ…

#### ActivitÃ© 2 : Stocker le nombre de critiques

4. **Activities** â†’ **Set Variable** â†’ glissez

5. Reliez **CompterDefaillancesCritiques** â†’ **Set Variable**

6. Onglet **General** : **Name** = `SetDefaillancesCritiques`

7. Onglet **Settings** :
   
   - **Variable** : `DefaillancesCritiques`
   - **Value** :
   
   ```
   @activity('CompterDefaillancesCritiques').output.firstRow.NbCritiques
   ```

#### ActivitÃ© 3 : Lire toutes les batteries

8. **Activities** â†’ **Lookup** â†’ glissez
9. Reliez **SetDefaillancesCritiques** â†’ **Lookup**
10. Onglet **General** : **Name** = `LireBatteries`
11. Onglet **Settings** :
    - **Connection** : `LH_Energie_Crisis`
    - **Root folder** : **Tables**
    - **Table** : `batteries`
    - **First row only** : **DÃ‰COCHEZ** âŒ

#### ActivitÃ© 4 : Router selon le niveau de crise (SWITCH)

12. **Activities** â†’ **Switch** â†’ glissez
13. Reliez **LireBatteries** â†’ **Switch**
14. Onglet **General** : **Name** = `RouterSelonNiveauCrise`
15. Onglet **Activities** â†’ **Expression** :

```
@if(lessOrEquals(variables('DefaillancesCritiques'), 5), 'Niveau1', if(lessOrEquals(variables('DefaillancesCritiques'), 10), 'Niveau2', 'Niveau3'))
```

ğŸ’¡ **Logique** :

- â‰¤ 5 critiques â†’ Niveau 1 (crise lÃ©gÃ¨re)
- 6-10 critiques â†’ Niveau 2 (crise moyenne)
- > 10 critiques â†’ Niveau 3 (crise majeure)

#### Configurer les 3 branches du Switch

**Branche Niveau 1** :

16. Dans **Cases** â†’ **Add case**

17. **Value** : `Niveau1`

18. Cliquez sur le **crayon** pour Ã©diter

19. Ajoutez **Set Variable** :
    
    - **Name** : `SetNiveauCrise1`
    - **Variable** : `NiveauCrise`
    - **Value** : `@int('1')`

20. Ajoutez **Copy Data** :
    
    - **Name** : `CopierPrioritesNiveau1`
    
    - Reliez **SetNiveauCrise1** â†’ **Copy Data**
    
    - **Source** (LH_Energie_Crisis) :
    
    - **Use query** : **T-SQL Query**
    
    - **Query** :
    
    ```sql
    SELECT * FROM diagnostic WHERE Severite = 'Critique' ORDER BY Priorite
    ```
    
    - **Destination** (LH_Energie_Decision) :
    - **Table** : `priorites`
    - **Table action** : **Overwrite**

**Branche Niveau 2** :

21. **Add case** â†’ **Value** : `Niveau2`

22. RÃ©pÃ©tez avec :
    
    - **Set Variable** : `NiveauCrise` = `@int('2')`
    - **Copy Data** avec requÃªte :
    
    ```sql
    SELECT * FROM diagnostic WHERE Severite IN ('Critique', 'Majeure') ORDER BY Severite, Priorite
    ```

**Branche Niveau 3** :

23. **Add case** â†’ **Value** : `Niveau3`

24. RÃ©pÃ©tez avec :
    
    - **Set Variable** : `NiveauCrise` = `@int('3')`
    - **Copy Data** avec requÃªte :
    
    ```sql
    SELECT * FROM diagnostic ORDER BY Severite, Priorite
    ```

#### ActivitÃ© 5 : Filtrer les batteries disponibles

25. Retournez au canvas principal (fil d'Ariane)

26. **Activities** â†’ **Filter** â†’ glissez

27. Reliez **RouterSelonNiveauCrise** â†’ **Filter**

28. Onglet **General** : **Name** = `FiltrerBatteriesDisponibles`

29. Onglet **Settings** :
    
    - **Items** :
    
    ```
    @activity('LireBatteries').output.value
    ```
    
    - **Condition** :
    
    ```
    @and(equals(item().Statut, 'Disponible'), greater(float(item().ChargeActuelle), 50))
    ```

ğŸ’¡ **Logique** : Garde uniquement les batteries disponibles avec charge > 50%

30. Cliquez **Save**

---

### 7. Tester Pipeline 2

1. Cliquez **Run**

2. Attendez 20-40 secondes

3. Observez l'**Output** :
   
   - **CompterDefaillancesCritiques** : `NbCritiques` = 11-15 (selon donnÃ©es)
   - **RouterSelonNiveauCrise** : Branche `Niveau3` exÃ©cutÃ©e (> 10 critiques)
   - **FiltrerBatteriesDisponibles** : Batteries filtrÃ©es

4. VÃ©rifiez dans **LH_Energie_Decision** â†’ **Tables** :
   
   - âœ… `priorites` (25 lignes - toutes les dÃ©faillances car Niveau 3)

5. VÃ©rifiez les **Variables** :
   
   - `DefaillancesCritiques` : 11-15
   - `NiveauCrise` : 3
   - `CapaciteBackupDisponible` : 0 (pas encore calculÃ©)

---

### 8. Configurer Pipeline 3 : Orchestration

**Objectif** : ExÃ©cuter sÃ©quentiellement Pipeline 1 â†’ Wait â†’ Pipeline 2

#### CrÃ©er les variables

Onglet **Variables** :

**Variable 1** :

- **Name** : `HeureDebutCrise`
- **Type** : `String`

**Variable 2** :

- **Name** : `HeureFinAnalyse`
- **Type** : `String`

**Variable 3** :

- **Name** : `DureeTotale`
- **Type** : `Integer`
- **Default value** : `0`

#### ActivitÃ© 1 : ExÃ©cuter le chargement

1. **Activities** â†’ **Execute Pipeline** â†’ glissez
2. Onglet **General** : **Name** = `Invoke Pipeline Crisis`
3. Onglet **Settings** :
   - **Invoked pipeline** : SÃ©lectionnez `PL_Chargement_Crise`
   - **Wait on completion** : âœ…

#### ActivitÃ© 2 : Synchronisation

4. **Activities** â†’ **Wait** â†’ glissez
5. Reliez **Invoke Pipeline Crisis** â†’ **Wait**
6. Onglet **General** : **Name** = `Wait 3 sec`
7. Onglet **Settings** :
   - **Wait time in seconds** : `3`

ğŸ’¡ **Raison** : Laisser le temps Ã  Fabric de finaliser l'Ã©criture des tables

#### ActivitÃ© 3 : ExÃ©cuter l'analyse

8. **Activities** â†’ **Execute Pipeline** â†’ glissez

9. Reliez **Wait 3 sec** â†’ **Execute Pipeline**

10. Onglet **General** : **Name** = `Invoke Pipeline Analysis`

11. Onglet **Settings** :
    
    - **Invoked pipeline** : SÃ©lectionnez `PL_Analyse_Crise`
    - **Wait on completion** : âœ…

12. Cliquez **Save**

---

### 9. Tester Pipeline 3 (Orchestration complÃ¨te)

1. Cliquez **Run**

2. Attendez 1-2 minutes (exÃ©cution de bout en bout)

3. Observez l'**Output** :
   
   - âœ… **Invoke Pipeline Crisis** : Succeeded (6 tables crÃ©Ã©es)
   - âœ… **Wait 3 sec** : Succeeded
   - âœ… **Invoke Pipeline Analysis** : Succeeded (table `priorites` crÃ©Ã©e)

4. VÃ©rifiez le temps total d'exÃ©cution dans **Output**

---

### 10. Valider l'architecture complÃ¨te

#### VÃ©rification Lakehouse Crisis

Ouvrez **LH_Energie_Crisis** â†’ **Tables** :

- âœ… `diagnostic` (25 lignes)
- âœ… `batteries` (20 lignes)
- âœ… `acteurs` (40 lignes)
- âœ… `conversion` (10 lignes)
- âœ… `sources` (75 lignes)
- âœ… `postcrise` (20 lignes)

#### VÃ©rification Lakehouse Decision

Ouvrez **LH_Energie_Decision** â†’ **Tables** :

- âœ… `priorites` (5-25 lignes selon niveau de crise)

---

## RÃ©sultat attendu

```
ğŸ“Š LH_Energie_Crisis/Tables/ (DonnÃ©es brutes)
â”œâ”€â”€ diagnostic (25 dÃ©faillances)
â”œâ”€â”€ batteries (20 sites)
â”œâ”€â”€ acteurs (40 contacts)
â”œâ”€â”€ conversion (10 sites H2)
â”œâ”€â”€ sources (75 sources renouvelables)
â””â”€â”€ postcrise (20 actions)

ğŸ“Š LH_Energie_Decision/Tables/ (DonnÃ©es de dÃ©cision)
â””â”€â”€ priorites (dÃ©faillances priorisÃ©es selon niveau crise)

ğŸ“‹ Variables PL_Analyse_Crise :
â”œâ”€â”€ DefaillancesCritiques : 11-15
â”œâ”€â”€ NiveauCrise : 3 (crise majeure)
â””â”€â”€ CapaciteBackupDisponible : 0

â±ï¸ Temps d'exÃ©cution Pipeline Orchestration :
â”œâ”€â”€ PL_Chargement_Crise : 30-60 sec
â”œâ”€â”€ Wait : 3 sec
â”œâ”€â”€ PL_Analyse_Crise : 20-40 sec
â””â”€â”€ TOTAL : 60-120 secondes

ğŸ”„ ActivitÃ©s clÃ©s utilisÃ©es :
âœ… Copy Data (6 en parallÃ¨le)
âœ… Lookup (avec/sans First Row Only)
âœ… Set Variable (classification niveau crise)
âœ… Switch (routage sur 3 niveaux)
âœ… Filter (batteries charge > 50%)
âœ… Execute Pipeline (orchestration)
âœ… Wait (synchronisation)
```

---

## ğŸ“ Points techniques importants

### 1. Switch vs If Condition

**Switch** est utilisÃ© ici car nous avons **3 branches possibles** :

- Niveau 1 (â‰¤ 5 critiques)
- Niveau 2 (6-10 critiques)
- Niveau 3 (> 10 critiques)

**If Condition** est limitÃ© Ã  2 branches (True/False).

### 2. Filter Activity

La condition du Filter utilise :

```
@and(equals(item().Statut, 'Disponible'), greater(float(item().ChargeActuelle), 50))
```

âš ï¸ **Attention** : `float()` est nÃ©cessaire car `ChargeActuelle` peut Ãªtre un string dans le CSV.

### 3. Execute Pipeline

L'orchestration utilise **waitOnCompletion = true** pour :

- Bloquer l'exÃ©cution jusqu'Ã  la fin du pipeline invoquÃ©
- Garantir l'ordre sÃ©quentiel : Chargement â†’ Analyse

### 4. Ordre des activitÃ©s dans Pipeline 2

```
CompterDefaillancesCritiques
    â†“
SetDefaillancesCritiques
    â†“
LireBatteries â† IMPORTANT : Avant le Switch !
    â†“
RouterSelonNiveauCrise (Switch)
    â†“
FiltrerBatteriesDisponibles
```

âš ï¸ **Erreur frÃ©quente** : Mettre `LireBatteries` APRÃˆS le Switch provoque une erreur de rÃ©fÃ©rence.

---

## ğŸ¯ Cas d'usage mÃ©tier

Ce pipeline orchestre automatiquement :

1. **Diagnostic rapide** : 6 sources ingÃ©rÃ©es en < 60 sec
2. **Classification intelligente** : Niveau de crise dÃ©terminÃ© automatiquement
3. **Priorisation dynamique** : Les dÃ©faillances critiques en tÃªte de liste
4. **Mobilisation des ressources** : Batteries disponibles identifiÃ©es
5. **Coordination** : Base pour alerter les 40 acteurs mobilisables
6. **TraÃ§abilitÃ©** : Temps d'exÃ©cution et variables tracÃ©es

**Impact rÃ©el** :

- â±ï¸ **Temps de rÃ©ponse** : < 2 minutes (vs 2-4 heures en manuel)
- ğŸ¯ **PrÃ©cision** : 100% des dÃ©faillances critiques identifiÃ©es
- ğŸ”„ **ReproductibilitÃ©** : ExÃ©cution identique Ã  chaque crise
- ğŸ“Š **TraÃ§abilitÃ©** : Historique complet des dÃ©cisions


