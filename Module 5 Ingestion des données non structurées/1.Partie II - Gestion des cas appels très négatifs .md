

# Atelier 6 : Pipeline déclenché par arrivée de fichier + alerte Activator sur appels très négatifs

**Objectif concret**  
Vous allez créer un **pipeline Data Factory** qui se déclenche automatiquement dès qu’un nouveau fichier audio arrive dans OneLake, le traite (transcription + enrichissement IA), puis utilise **Activator** pour envoyer une alerte Teams immédiate lorsque l’appel est classé « Très négatif ».

**Résultat final visible**  

- Pipeline qui s’exécute seul à chaque nouveau fichier audio  
- Table mise à jour en temps réel  
- Notification Teams automatique pour tout appel « Très négatif » avec lien direct vers l’audio et la transcription

## Fichiers nécessaires (déjà prêts de l’atelier 5)

- Lakehouse `LH_AppelsClients_2026`  
- Dossier `Files/audio_raw/mock_appels_mp3/`  
- Notebook `NB_01_Ingestion_Transcription_Enrichissement` (de l’atelier précédent)  
- Table Delta `silver.appels_clients_energetique`

---

## Étape 1 – Création du Pipeline

1. Dans votre espace de travail `WS_VoixClients_Energetique`, cliquez **+ Nouveau** → **Data pipeline**
2. Nommez-le : `PL_01_Traitement_Audio_Automatique`
3. Cliquez **Créer**

## Étape 2 – Configuration du déclencheur sur arrivée de fichier

1. Dans le pipeline, cliquez sur **Ajouter un déclencheur** → **Nouveau déclencheur**

2. Type de déclencheur : **OneLake file event**

3. Configurez comme suit :
   
   - **Workspace** : Votre workspace actuel
   - **Lakehouse** : `LH_AppelsClients_2026`
   - **Folder path** : `Files/audio_raw/mock_appels_mp3`
   - **Event type** : `FileCreated`
   - **File name pattern** : `*.mp3`

4. Nommez le déclencheur : `Trigger_NewAudioFile`

5. Cliquez **Appliquer**

## Étape 3 – Ajout du Notebook d’exécution

1. Dans le canvas du pipeline, cliquez **Ajouter une activité** → **Notebook**

2. Nommez l’activité : `Exécuter_Transcription_Enrichissement`

3. Dans les paramètres :
   
   - **Lakehouse** : `LH_AppelsClients_2026`
   - **Notebook** : Sélectionnez `NB_01_Ingestion_Transcription_Enrichissement`

4. Dans l’onglet **Paramètres**, ajoutez un paramètre dynamique pour traiter uniquement le nouveau fichier :
   
   - Paramètre : `file_path`
   - Valeur : `@triggerBody().folderPath + '/' + triggerBody().fileName`

5. Dans le notebook (vous devrez l’adapter légèrement), remplacez le chemin fixe par le paramètre :

```python
# Dans le notebook, remplacez la cellule 2 par :
file_path = spark.conf.get("file_path", "Files/audio_raw/mock_appels_mp3/")

df_audio = spark.read.format("binaryFile") \
    .option("pathGlobFilter", "*.mp3") \
    .load(file_path)
```

## Étape 4 – Sauvegarde et mise à jour de la table

1. Ajoutez une nouvelle activité **Notebook** après la précédente
2. Nommez-la : `MiseAJour_Table_Silver`
3. Utilisez le même notebook ou créez une activité **Dataflow Gen2** pour faire un simple `MERGE` ou `APPEND` dans la table Delta.

**Solution recommandée (plus simple)** : Dans le même notebook, ajoutez à la fin :

```python
# À ajouter à la fin du notebook de l’atelier 5
df_final.write \
    .mode("append") \
    .option("mergeSchema", "true") \
    .format("delta") \
    .saveAsTable("silver.appels_clients_energetique")
```

## Étape 5 – Configuration de l’alerte avec Activator (Real-Time Intelligence)

1. Dans l’espace de travail, cliquez **+ Nouveau** → **Activator**
2. Nommez-le : `ACT_Alertes_Appels_TresNegatifs`
3. Cliquez **Créer**

**Configuration de l’Activator :**

1. **Source** → Sélectionnez votre Lakehouse `LH_AppelsClients_2026`

2. **Table** → `silver.appels_clients_energetique`

3. **Type de détection** → **When a row is added or updated**

4. **Condition** :
   
   ```sql
   niveau_sentiment = 'Très négatif'
   ```

5. **Action** → **Envoyer un message Teams**

6. Configurez le message Teams :
   
   **Titre** : `⚠️ Appel Très Négatif Détecté`
   
   **Message** :
   
   ```
   Un nouvel appel très négatif a été détecté !
   
   Fichier : @{triggerBody().filename}
   Sentiment : @{triggerBody().niveau_sentiment}
   Intent : @{triggerBody().intent}
   Transcription : @{left(triggerBody().transcription, 300)}...
   
   Écouter l'audio : https://onelake.dfs.fabric.microsoft.com/.../@{triggerBody().filename}
   ```

7. Choisissez le canal Teams (créez un canal dédié "Alertes Service Client" si possible)

8. Cliquez **Publier**

## Étape 6 – Test complet du scénario

1. Dans le Lakehouse, allez dans `Files/audio_raw/mock_appels_mp3/`
2. Copiez un fichier existant et renommez-le `appel_999_Test.mp3`
3. Collez-le dans le même dossier (cela déclenche le FileCreated event)

**Vérifications attendues :**

- Le pipeline `PL_01_Traitement_Audio_Automatique` se lance automatiquement
- La table `silver.appels_clients_energetique` reçoit une nouvelle ligne
- Vous recevez une notification Teams en moins de 30 à 90 secondes

**Astuce** : Pour tester plus vite, utilisez **Debug** sur le pipeline avant d’activer le trigger.

**Piège courant** : Le déclencheur OneLake file event ne fonctionne que si le fichier est **complètement écrit** (pas pendant l’upload). Attendez toujours la fin du transfert.

---

**Prochain atelier** : Atelier 7 – Dashboard Power BI avancé + Copilot + score de risque churn en temps réel
