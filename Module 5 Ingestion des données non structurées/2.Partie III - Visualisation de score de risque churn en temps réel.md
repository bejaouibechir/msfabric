# Atelier 7 : Dashboard Power BI avancé + Copilot + score de risque churn en temps réel

**Objectif concret**  
Vous allez créer un **rapport Power BI** moderne et opérationnel à partir de la table `silver.appels_clients_energetique`, ajouter un **score de risque de churn** calculé en DAX, intégrer **Copilot** pour des analyses conversationnelles, et terminer par un **rafraîchissement automatique** via Direct Lake + Activator.

**Résultat final visible**  

- Un rapport Power BI avec :
  - Vue globale des sentiments et intents
  - Score de risque churn par appel (0–100)
  - Top 10 appels les plus critiques
  - Possibilité de poser des questions en langage naturel via Copilot
  - Mise à jour quasi temps réel des nouveaux appels

## Prérequis (issus des ateliers précédents)

- Lakehouse : `LH_AppelsClients_2026`
- Table Delta : `silver.appels_clients_energetique`
- Colonnes existantes : `filename`, `transcription`, `sentiment`, `niveau_sentiment`, `score_pos`, `score_neg`, `score_neu`, `intent`

## Étape 1 – Création du rapport Power BI

1. Dans le Lakehouse → onglet **Tables**
2. Clic droit sur `silver.appels_clients_energetique` → **Nouveau rapport Power BI**
3. Nommez le rapport : `Rapport_Appels_Clients_Energetique`
4. Attendez que le rapport s’ouvre (mode **Direct Lake** est automatiquement sélectionné)

## Étape 2 – Structure de base du rapport (pages et visuels)

Créez **trois pages** dans le rapport :

### Page 1 : Vue Globale

1. **Titre de page** : Vue d’ensemble – Appels clients

2. Ajoutez les visuels suivants :
   
   | Visuel                | Champ(s) principal(aux)                                | Configuration recommandée                                            | Titre du visuel                     |
   | --------------------- | ------------------------------------------------------ | -------------------------------------------------------------------- | ----------------------------------- |
   | Carte (KPI)           | COUNTROWS (mesure)                                     | Format → Police grande, couleur conditionnelle sur valeur > 50 rouge | Nombre total d’appels               |
   | Jauge                 | AVERAGE(score_neg)                                     | Min 0 – Max 1, couleur rouge au-dessus de 0.6                        | Score moyen négatif                 |
   | Graphique en anneau   | niveau_sentiment (légende), COUNTROWS                  | Couleurs : Très négatif = rouge foncé, Positif = vert                | Répartition par niveau de sentiment |
   | Graphique en colonnes | intent (axe), COUNTROWS                                | Tri décroissant                                                      | Intents les plus fréquents          |
   | Tableau               | filename, transcription (multiligne), niveau_sentiment | Tri par score_neg décroissant, mise en forme conditionnelle          | Derniers appels critiques           |

3. **Astuce mise en forme** :
   
   - Dans le volet **Format** du tableau → **Mise en forme conditionnelle** → **Arrière-plan** → Règle : si `niveau_sentiment` = "Très négatif" → Rouge (#C00000)
   - Activez **En-tête de colonne** → Police semi-gras, alignement centré

### Page 2 : Score de risque Churn

1. **Titre de page** : Risque de churn & appels prioritaires
2. Créez une **mesure DAX** importante (clic droit sur la table → Nouvelle mesure) :

```dax
Score Risque Churn = 
VAR ScoreNeg = [Score Négatif Moyen par Appel]   // à créer aussi
VAR IntentChurn = 
    CALCULATE(
        COUNTROWS('silver_appels_clients_energetique'),
        'silver_appels_clients_energetique'[intent] IN {"résiliation", "facturation / aides", "problème installation / SAV"}
    )
VAR ScoreIntent = 
    SWITCH(
        TRUE(),
        CONTAINSSTRING('silver_appels_clients_energetique'[intent], "résiliation"), 0.9,
        CONTAINSSTRING('silver_appels_clients_energetique'[intent], "facturation"), 0.6,
        CONTAINSSTRING('silver_appels_clients_energetique'[intent], "SAV"), 0.5,
        0.2
    )
RETURN
    ROUND(
        (ScoreNeg * 0.65 + ScoreIntent * 0.35) * 100,
        0
    )
```

3. Créez aussi cette mesure intermédiaire :

```dax
Score Négatif Moyen par Appel = 
AVERAGE('silver_appels_clients_energetique'[score_neg])
```

4. Visuels recommandés pour cette page :
   
   - **Carte** : `Score Risque Churn` (moyenne globale)
   - **Graphique en courbe** : `Score Risque Churn` par jour (si vous avez ajouté une colonne date)
   - **Tableau** : `filename`, `transcription`, `intent`, `niveau_sentiment`, `Score Risque Churn` (tri décroissant)
   - **Slicer** : `intent` + `niveau_sentiment` (multi-sélection activée)

### Page 3 : Analyse Copilot & Q&A

1. **Titre de page** : Analyse conversationnelle avec Copilot

2. Activez **Copilot** (si pas déjà fait) :
   
   - En haut à droite du rapport → **Copilot** → **Activer Copilot**

3. Ajoutez un visuel **Q&A** (ou laissez Copilot en mode libre)

4. Testez quelques questions naturelles (exemples à essayer directement) :
   
   - « Montre-moi les 10 appels les plus négatifs »
   - « Quel est le score de risque churn moyen ? »
   - « Quels intents reviennent le plus souvent chez les appels très négatifs ? »
   - « Résume les plaintes liées à la facturation »
   - « Y a-t-il des appels mentionnant 'résiliation' avec score négatif > 0.7 ? »

**Astuce Copilot** : Si Copilot propose un visuel qui vous plaît, cliquez **Ajouter au rapport** pour le conserver.

## Étape 3 – Mise en forme et ergonomie finale

1. **Thème** : Appliquez un thème sombre ou bleu corporate
   - Fichier → Options et paramètres → Thèmes → Parcourir les thèmes Microsoft
2. **Navigation** :
   - Activez **Volet de navigation** (gauche)
   - Ajoutez des boutons de navigation entre pages
3. **Filtre au niveau du rapport** :
   - Ajoutez un filtre permanent : `niveau_sentiment` contient "négatif" ou "Très négatif" (optionnel, pour focus opérationnel)
4. **Publication** :
   - Fichier → Publier → Sélectionnez votre workspace
   - Nommez le dataset : `Dataset_Appels_Energetique`

## Étape 4 – Rafraîchissement automatique & monitoring

1. Dans le workspace → **+ Nouveau** → **Dataflow Gen2**
2. Nommez-le : `DF_Refresh_Appels`
3. Source : Lakehouse → Table `silver_appels_clients_energetique`
4. Destination : même table (ou une table Gold si vous voulez une couche supplémentaire)
5. Activez **Planification** : toutes les 15 minutes (ou 5 min si capacity permet)
6. Publiez le dataflow

**Alternative plus puissante** : Utilisez **Activator** (comme dans l’atelier 6) pour rafraîchir uniquement quand un nouveau fichier arrive.

## Étape 5 – Tests finaux recommandés

- Ajoutez un nouveau fichier audio dans `audio_raw/mock_appels_mp3/`
- Attendez 1–3 minutes → vérifiez que :
  - La table Delta est mise à jour
  - Le rapport Power BI montre la nouvelle ligne
  - Copilot répond correctement aux questions sur le nouvel appel
  - Le score de churn est cohérent

**Astuce pro** : Épinglez le rapport sur la page d’accueil du workspace pour un accès ultra-rapide par l’équipe.

**Piège fréquent** : Si Copilot ne répond pas → vérifiez que votre capacity Fabric inclut les **AI Functions** et que le **Copilot toggle** est activé dans les paramètres du tenant.


